
# 计算机系统概述

## 操作系统是怎样启动的？
A： 通电，产生时钟信号，CPU开始工作，主板上的boot将磁盘中的os文件加载到内存中，cpu运行操作系统程序。  
***
## 计算机是怎样工作的？
A：CPU相当于大脑，进行计算任务；内存相当于眼睛，CPU运行的指令和处理的数据从内存中来；磁盘相当于外界，内存中没有运行的指令或者数据，则从硬盘中查找并将其调入内存。
***
## 操作系统的功能目的

A：计算机系统的层次如下，可见操作系统处于用户和硬件之间的层次。  
故向下操作系统是系统资源的管理者（资源包括进程/CPU，内存，文件/磁盘和外设I/O。  
向上为用户提供命令接口和系统调用给操作系统发出请求，使其管理硬件。用户不用去直接操作硬件，更加的简单易用。
    
     用 户
       | 
    操作系统
       |
     硬 件
***
## 如何理解某个功能由软件实现还是由硬件实现？
A：硬件先于软件出现，像是加减乘除等基本的运算可以由基本的电路实现，设计成电路之后这个电路就能作为一个实体完成单一功能。将多个实体集合起来就是将很多小功能集合起来，这样就形成了指令集。后来出现的软件就基于这些指令集。
***
## 简述操作系统发展的阶段
A： 
无操作系统。人将纸带装入纸带机，CPU在纸带上打孔，最后通过纸带机人工地将纸带取出，此时最大的问题在于人工干预，CPU资源被严重浪费。  
单道批处理系统。程序和数据实现被写入磁带，只将这一段程序读入内存进行处理，处理完毕后将结果输出到磁带中。解决了没有操作系统时的人工干预问题实现了自动，但是内存中只装载了一道程序，在I/O的过程中，CPU没有得到充分的利用。  
多道批处理系统。内存中有多道程序，一个进程在I/O的过程中将剥夺他的处理机分给另一个进程，这样就是CPU的利用率大幅提升。
分时操作系统。多个用户通过终端操作同一台主机，采用时间片流转的策略，每个进程在CPU上执行一个时间片的时间，这样就实现了人机交互。从用户的角度看，用户独占整个计算机。  
实时操作系统。对一些作业有时间上的要求，通常要求在规定的时间完成任务。  
网络操作系统，网络产生后用于网络的操作系统。  
分布式操作系统。多台计算机同时完成一个任务。例如服务器，通常需要多台计算机。注意负载均衡，当短时间某台服务器有大量请求时，将负载分配给其他服务器。  
个人操作系统。这个就很熟悉了，不再赘述。

***
## 简述操作系统的运行机制
运行机制主要依赖中断、异常和以及系统调用。中断，来自CPU外部的信号（是一种通知行为）。异常，来自程序内部的缺陷（是一种错误处理行为）。系统调用，进程请求操作系统提供服务（是一种请求行为）。
***
## 区分系统调用和API
API是对系统调用的进一步封装。系统调用是操作系统提供给程序的接口，这种接口参数多且复杂，不方便程序员使用。进而设计API对系统调用进行封装，提供给程序员更易使用的接口。
***
## 操作系统的特征
 操作系统的4个特征：并发、共享、虚拟、异步  
并发是指一段时间内系统运行多个程序。并行是指同一时刻系统运行多个程序。  
共享是指多个进程可以共享同一个资源，分为互斥共享方式和同时访问方式。互斥访问方式典型代表为打印机，同时访问方式典型代表为磁盘。  
虚拟是指单个物理设备在逻辑上可视为多个逻辑设备。如虚拟处理器，采用时分复用技术实现多个进程并发使用CPU；虚拟存储器，物理上16GB的内存可视为容量更大的逻辑内存，采用了空分复用技术。
***
## 操作系统体系结构

一开始是大内核，操作系统的功能都在内核里。随着内核的不断扩充，设计难度和管理难度都逐渐增加。于是将其拆分成微内核和服务程序，微内核是操作系统最重要的部分，实现了对资源的管理。体现了模块化的设计和分层的思想。
***

# 进程与线程

## 进程的构成

进程由进程控制块PCB、相关数据段、程序段构成。
### 进程控制块  
进程控制块PCB是进程存在的唯一标识，操作系统将进程控制块维护在内存中的系统区中，按进程状态组成就绪队列和阻塞队列这样的数据结构(也可以组织成索引结构)，这些数据结构属于内核临界资源。PCB是一种数据结构，储存了进程描述信息（PID、UID）、进程控制和管理信息（进程当前状态、进程优先级、进程调度的其他信息、事件）、处理机信息（通用寄存器X、指令寄存器PC、程序状态字、用户栈指针）等。进程进行状态切换时需要修改PCB的中的数据，进行调度是系统也要根据PCB获得进程的信息，主要是修改进程的控制信息。
### 相关数据段
注意相关数据段不是指数据段，是指以下提到的全部。数据段是存放静态变量和全局变量的内存区域。已经初始化的静态变量和全局变量存放在.data，没有被初始化的静态变量和全局变量存放在.bss。数据段是程序运行处理的对象，在程序装载到内存中就已经出现，属于静态分配的内存。栈和堆它们是程序运行过程中进行内存分配的。栈，通常也称堆栈，是用来实现函数调用的硬件栈，会存放函数调用过程中的数据，例如函数返回地址，传参和函数体内的局部变量。堆，存放程序员显式地请求系统动态分配的变量。这里所提到的栈和堆要区分于数据结构中的栈和堆，它们是硬件上的内存区域。
### 程序段
代码段，存放程序的二进制代码。通常存放只读的代码，也会存放一些常量，比如字符串常量等。

## 进程的状态

主要是5种状态，创建态、就绪态、运行态、阻塞态和终止态。
### 创建态
启动程序执行、终端用户登录等事件都会引起进程的创建，创建进程需要用创建原语。
1. 操作系统为进程分配空白的PCB，如果PCB创建失败，则进程创建失败。
2. 操作系统为进程分配所需的资源，这些资源从操作系统或者父进程获得，如果资源分配失败则进程则处于创建态，注意是创建态不是阻塞态，因为此时进程还在创建的过程中，仅有此时进程是创建态的。
3. 初始化PCB，当资源分配完成后进行PCB的初始化工作。
4. 如果等待队列能够接纳新进程，则将PCB插入到就绪队列中。

### 就绪态
已经获得除处理机外的全部资源时是就绪态。处于就绪态的进程在就绪队列中等待系统调度。

### 阻塞态
获得处理机资源的进程，由于等待一种资源而不能继续进行时，进程应主动请求操作系统将其阻塞。  
典型的例子是A进程想要使用打印机，而打印机正在被其他进程占用，这时A进程不应占用处理机资源，而是应当主动放弃处理机等待其他进程使用完打印机，这个例子是多个进程访问临界资源时产生阻塞的情况，属于两个进程互斥访问临界资源。  
另一个例子是B进程等待C进程提供数据，虽然B进程占用处理机资源，但是此时它并不能继续运行，那么B进程应主动申请阻塞让出处理机等待C进程完成，这个例子是两个进程同步的例子。  
值得注意的是中断并不一定会导致进程的阻塞。例如D进程请求操作系统动态地为它分配一片内存区域，请求系统调用后，会保存现场，操作系统处理中断后会分配内存给D进程，D进程时间片未用完可以则可以继续上处理机执行。E进程在处理机上运行过程某指令后，处理机接收到了I/O完成的中断信号，此时应该保存现场进行中断处理，然后将现场恢复，E进程继续运行。
上述处理中断的具体过程说法不一，将在学习完组成原理之后补充。暂时给出一个不太严谨的过程。
以E进程收到I/O完成信号为例。CPU在一条指令执行结束后检测到中断信号，此时硬件自动将程序计数器/断点/PCB的下一条指令和程序状态字PSW压入中断栈中，CPU的PSW状态进行切换，根据该中断信号对应的中断向量，该中断向量指向中断处理程序的入口地址，以上处理都是由硬件完成。操作系统将剩余寄存器的数据保存到中断栈中，就可以将中断向量置入PC处理中断处理程序，上述处理程序运行了I/O完成后的处理，将一些可能被阻塞的进程唤醒。中断处理程序运行完成后将从中断栈中恢复处理机的现场信息。中断栈是操作系统内核维护的，用于处理进程中断的栈。此外还有内核栈，内核栈是操作系统在内核态是用于为进程提供服务时所用到的栈，内核栈应该为每个进程单独设置。
进程阻塞是进程主动的行为，用阻塞原语实现。进程请求系统调用，发生访管中断，操作系统使用阻塞原语。

1. 操作系统寻找申请阻塞的PCB
2. 保存处理器现场，更新PCB的进程状态
3. 将PCB插入相应事件的阻塞队列中

当事件完成后需要唤醒，发生中断，操作系统使用唤醒原语
1. 操作系统在阻塞队列中找到相应需要唤醒的PCB
2. 更新PCB的进程状态
3. 将PCB插入就绪队列

## 进程的通信
进程的通信分为低级通信和高级通信。低级通信就是PV操作，它对信号量进行修改。高级通信是两个进程需要传输大量数据，高级通信有共享存储、消息传递和管道通信三种。  
### 共享存储
通常进程的地址空间的物理地址空间是相互独立的，进程的物理地址空间对于其他进程是透明的。通过特殊的系统调用申请一块内存为两个进程共有，进程能够在这片内存中交换数据，这种方式就是共享存储。实现共享存储的原理是不同进程的逻辑地址空间经过页表映射到相同的物理空间中。由以上过程可知共享存储只需要一次系统调用，之后进程之间的通信都在共享存储中进行；以共享存储方式通信时需要注意数据的同步和互斥，需要操作系统提供互斥同步工具。
### 消息传递 
将数据封装成消息，通过操作系统提供的发送原语和接收原语进行消息的传递，通信过程对用户透明。例如微内核中提供消息传递机制，用户进程与服务器进程（微内核中实现资源管理的功能在内核外作为服务器进程存在）进行通信。由于消息传递需要使用原语，则这种方式需要内核的支持。消息传递分为直接通信和间接通信。直接通信，发送进程直接将消息发送给接收进程，并将消息挂起在接收进程的消息队列上，接收进程从消息队列中取得消息。消息队列实际上是内核的一个链表，所以进行发信时将产生状态的变化。间接通信，发送进程将消息发送到某一中间实体，接收进程从中间实体中取得消息，通常中间实体也被称为信箱。
### 管道通信
连接一个读进程和一个写进程的文件（缓冲区），视为共享存储的优化与发展。

# 内存管理

## 进程的内存映像
以32位虚拟地址空间为例，地址空间的0xC0000000到0xFFFFFFFF（1G的高地址部分）是内核区，剩下的为用户区。由此可见操作系统在逻辑上属于每个进程，因为进程都可以通过系统调用请求内核服务。进程运行在用户区时为用户态，进程运行在内核区时为内核态。系统调用时发生访管中断，CPU变为内核态处理中断，在这个过程中CPU处理中断的过程中，内核在逻辑上是属于该进程的一部分。
